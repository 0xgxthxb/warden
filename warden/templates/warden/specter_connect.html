{%if current_user.is_authenticated%}
{% extends "warden/warden_layout.html" %}
{%endif%}
{% block content %}

{%if not current_user.is_authenticated%}
<link rel="stylesheet" href="{{url_for('warden.static', filename='css/welcome.css')}}">
<link rel="stylesheet" href="{{url_for('warden.static', filename='dependencies/font-awesome/css/all.css')}}">
<link rel="stylesheet" href="{{url_for('warden.static', filename='dependencies/bootstrap/css/bootstrap.min.css')}}">

<title>The WARDen | Welcome | Connect to Specter</title>
<link rel="icon" href="{{url_for('warden.static', filename='images/favicon-bitcoin.ico')}}" class="invert">
{%endif%}

<div id="container" style='color:rgb(61, 61, 61);'>
    <section class="showcase" class='slide_div_out'>

        {%if not specter_running%}
        <div class="content" style='color:rgb(61, 61, 61);'>
            <img src='{{url_for('warden.static', filename='images/specter_icon.png')}}' width="50">
            <h4>
                Connect to Specter Server<br>
                {%if not current_user.is_authenticated%}
                <a class="btn btn-outline-secondary" href="/" role="button">Skip this step</a>
                {%endif%}
            </h4>

            <hr>

            <form class='' action="{{ url_for('warden.specter_auth') }}" method="post">

                <div class="row text-left">
                    <div class='col-2'>
                    </div>
                    <div class='col-10'>
                        <p>
                            <img src='{{url_for('warden.static', filename='images/Tor-logo.png')}}' width="35">
                            &nbsp;Onion Addresses are supported<small><br> (Go to Specter > Settings > Tor > Enable Tor
                                Hidden
                                Service)</small>
                        </p>
                    </div>
                </div>

                <div class="form-group row text-left">

                    <label for="colFormLabelLg" class="col-sm-2 col-form-label col-form-label">Specter Server
                        URL</label>
                    <div class="col-sm-10">

                        <input type="text" class="form-control form-control" name="url"
                            value="{{current_app.settings['SPECTER']['specter_url']}}">
                        <small class='text-left'>
                            <p style='padding-top:20px;'>Typically this is http://127.0.0.1:25441/ or
                                http://localhost:25441/</p>
                        </small>
                    </div>
                </div>
                <div class="form-group row text-left">
                    <label for="colFormLabelLg" class="col-sm-2 col-form-label col-form-label">Username<span
                            class='small text-muted'>&nbsp;&nbsp;(blank if
                            None)</span></label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control form-control" name="username"
                            value="{{current_app.settings['SPECTER']['specter_login']}}">
                    </div>
                </div>
                <div class="form-group row text-left">
                    <label for="colFormLabelLg" class="col-sm-2 col-form-label col-form-label">Password<span
                            class='small text-muted'>&nbsp;&nbsp;(blank if
                            None)</span></label>
                    <div class="col-sm-10 text-left">
                        <input type="password" class="form-control form-control" name="password"
                            value="{{current_app.settings['SPECTER']['specter_password']}}">
                        <br>
                        <button id='submit_button' type="submit" class="btn btn-lg btn-outline-primary">Connect</button>
                        {%if not current_user.is_authenticated%}
                        <a class="btn btn-lg btn-outline-secondary" href="/" role="button">Skip</a>
                        {%endif%}
                    </div>
                </div>


            </form>

            <div id="output" class='content-section text-left' style='background-color: rgb(245, 245, 245);'>
                <pre>Connection Log (Waiting to connect...)</pre>
            </div>

            <h5 class='text-left' style='padding-top:50px;''>Why connect to Specter Server?</h5>
            <p class=' text-left'><i class="fas fa-ghost"></i>&nbsp;Automatically download Bitcoin transactions into
                your
                portfolio</p>
                <p class='text-left'><i class="fas fa-ghost"></i>&nbsp;Wallet summary and activity notification</p>
                <p class='text-left'><i class="fas fa-ghost"></i>&nbsp;Check your stack progress</p>
                <br>
                <h5 class='text-left'>Is it safe?</h5>
                <p class='text-left'>
                    <i class="fas fa-plug"></i>&nbsp;The WARden will connect to Specter Server the same way your browser
                    does.</p>
                <p class='text-left'>
                    <i class="fab fa-github"></i>&nbsp;But don't trust us, check the code to see how it's done (check
                    file
                    <a class='' style="text-decoration : none" href='https://github.com/pxsocs/specter_warden/'><span
                            style='color: darkgreen'>specter_importer.py</span></a>).
                </p>
                <p class='text-left'><i class="fas fa-file-import"></i>&nbsp;Alternatively, you can choose not to
                    connect
                    Specter Server and manually import a csv
                    file with your
                    transactions later.</p>


        </div>
        {%else%}

        <div class="content" style='color:rgb(61, 61, 61);'>
            <h4><i class="fas fa-ghost text-success"></i>&nbsp;&nbsp;Connected to Specter Server</h4>
            <br>
            <p>
                <i class="far fa-check-square text-success"></i>&nbsp;
                Specter Server url: <a href="{{url}}" target='_blank'>{{url}}</a>
            </p>
            <p>
                <i class="far fa-check-square text-success"></i>&nbsp;
                Running Specter Version: {{current_app.specter.home_parser['version']}}
            </p>
            <p>
                <i class="far fa-check-square text-success"></i>&nbsp;
                Running Bitcoin Core Version:
                {{current_app.specter.home_parser['bitcoin_core_data']['Bitcoin Core Version']}}
            </p>
            <a href="/" class="btn btn-info">Go to WARden Dashboard</a>
            {%endif%}
        </div>
    </section>
</div>


<script>
    $('#submit_button').click(function () {
        $('#submit_button').html(
            'Checking Credentials. Check Connection Log. Please Wait. This can take a few minutes...');
        var intervalId = window.setInterval(function () {
            run_ajax()
        }, 1000);
    });

    function run_ajax() {
        table_header = `
    <h6>Connection Log</h6>
    <table class='table table-sm table-striped small-text' id='list_table_json'>
        <thead>
          <tr>
            <th>Time</th>
            <th>Category</th>
            <th>Message</th>
            <th>Notes</th>
          </tr>
        </thead>
    <tbody>
    `
        table_footer = "</tbody></table>"
        $.ajax({
            type: "GET",
            dataType: 'json',
            url: "/broadcaster?category={{category}}",
            success: function (data) {
                $('#output').html('')
                if (data == '') {
                    $('#output').html(
                        "<div class='small alert alert-info' role='alert'>No messages from this session yet. But monitoring realtime." +
                        "</div>"
                    )
                } else {
                    /*console.log(data);*/
                    var event_data = '';
                    $.each(data, function (index, value) {
                        /*console.log(value);*/
                        event_data += '<tr>';
                        event_data += '<td>' + value.time_str + '</td>';
                        event_data += '<td>' + value.category + '</td>';
                        event_data += '<td>' + value.message_txt + '</td>';
                        event_data += '<td>' + value.notes + '</td>';
                        event_data += '</tr>';
                    });
                    $("#output").html(table_header + event_data + table_footer)

                }

            },
            error: function (xhr, status, error) {
                $('#output').html(
                    "<div class='small alert alert-danger' role='alert'>An error occured while refreshing debug data." +
                    "</div>"
                )
            }
        });
    }
</script>

{%endblock%}